#!/bin/sh

# thresholds in percent (env override possible)
WARN_PCT="${WARN_PCT:-85}"
CRIT_PCT="${CRIT_PCT:-95}"

to_mb() {
  RAW="$1"

  # extract numeric value and unit
  VAL=$(printf "%s" "$RAW" | sed -E 's/^([0-9]+(\.[0-9]+)?).*/\1/')
  UNIT=$(printf "%s" "$RAW" | sed -E 's/^[0-9]+(\.[0-9]+)?//')

  case "$UNIT" in
    GiB) awk -v v="$VAL" 'BEGIN { printf "%.0f", v * 1024 }' ;;
    MiB) awk -v v="$VAL" 'BEGIN { printf "%.0f", v }' ;;
    KiB) awk -v v="$VAL" 'BEGIN { printf "%.0f", v / 1024 }' ;;
    *)   echo 0 ;;
  esac
}

docker stats --no-stream --format "{{.Name}}|{{.MemUsage}}" 2>/dev/null | \
while IFS='|' read -r NAME MEMUSAGE; do
  [ -z "$NAME" ] && continue
  [ -z "$MEMUSAGE" ] && continue

  # Expected format: "<used> / <limit>"
  USED_RAW=$(printf "%s" "$MEMUSAGE" | awk '{print $1}')
  LIMIT_RAW=$(printf "%s" "$MEMUSAGE" | awk '{print $3}')

  USED_MB=$(to_mb "$USED_RAW")
  LIMIT_MB=$(to_mb "$LIMIT_RAW")

  # skip containers without real memory limit
  [ "$LIMIT_MB" -le 0 ] && continue

  WARN_MB=$((LIMIT_MB * WARN_PCT / 100))
  CRIT_MB=$((LIMIT_MB * CRIT_PCT / 100))

  echo "P \"Docker memory ${NAME} (MB)\" used=${USED_MB};${WARN_MB};${CRIT_MB};0;${LIMIT_MB} ${NAME} uses ${USED_MB}/${LIMIT_MB} MB"
done
