#!/bin/sh

# thresholds in percent (logical zram fullness)
WARN_PCT="${ZRAM_WARN_PCT:-70}"
CRIT_PCT="${ZRAM_CRIT_PCT:-90}"

STAT="/sys/block/zram0/mm_stat"
DISKSIZE="/sys/block/zram0/disksize"

# ------------------------------------------------------------
# zram not active
# ------------------------------------------------------------
if [ ! -r "$STAT" ] || [ ! -r "$DISKSIZE" ]; then
  echo "0 \"zram used\" zram_filled_mb=0;0;0;0;0 zram not active"
  echo "0 \"zram compression\" compression_ratio=0 zram not active"
  exit 0
fi

read orig compr mem limit max same compact huge huge_since < "$STAT"
zram_size=$(cat "$DISKSIZE")

# ------------------------------------------------------------
# helpers
# ------------------------------------------------------------
human() {
  awk -v x="$1" 'BEGIN {
    unit[1]="B"; unit[2]="KB"; unit[3]="MB"; unit[4]="GB"; unit[5]="TB"
    i=1
    while (x>=1024 && i<5) { x/=1024; i++ }
    printf "%.2f%s", x, unit[i]
  }'
}

to_mb() {
  awk -v x="$1" 'BEGIN { printf "%.0f", x/1024/1024 }'
}

orig_h=$(human "$orig")
mem_h=$(human "$mem")

orig_mb=$(to_mb "$orig")
size_mb=$(to_mb "$zram_size")

# ------------------------------------------------------------
# compression ratio
# ------------------------------------------------------------
if [ "$compr" -gt 0 ]; then
  ratio=$(awk "BEGIN { printf \"%.2f\", $orig / $compr }")
else
  ratio="0"
fi

# ------------------------------------------------------------
# relative fullness + state
# ------------------------------------------------------------
state=0
fill_pct=0

if [ "$size_mb" -gt 0 ]; then
  fill_pct=$(awk "BEGIN { printf \"%.0f\", ($orig_mb*100)/$size_mb }")
  [ "$fill_pct" -ge "$WARN_PCT" ] && state=1
  [ "$fill_pct" -ge "$CRIT_PCT" ] && state=2
fi

# ------------------------------------------------------------
# thresholds in MB (derived from percent)
# ------------------------------------------------------------
warn_mb=$(awk "BEGIN { printf \"%.0f\", ($size_mb*$WARN_PCT)/100 }")
crit_mb=$(awk "BEGIN { printf \"%.0f\", ($size_mb*$CRIT_PCT)/100 }")

# ------------------------------------------------------------
# Service 1: zram used (MB for proper graph scaling)
# ------------------------------------------------------------
echo "$state \"zram used (mb)\" zram_filled_mb=${orig_mb};${warn_mb};${crit_mb};0;${size_mb} logical=$orig_h, real=$mem_h, fill=${fill_pct}%"

# ------------------------------------------------------------
# Service 2: zram compression (ratio graph)
# ------------------------------------------------------------
echo "0 \"zram compression\" compression_ratio=${ratio} compression=${ratio}:1"
