#!/bin/sh

# thresholds in percent (logical zram fullness)
WARN_PCT=70
CRIT_PCT=90

STAT="/sys/block/zram0/mm_stat"
DISKSIZE="/sys/block/zram0/disksize"

# ------------------------------------------------------------
# zram not active
# ------------------------------------------------------------
if [ ! -r "$STAT" ] || [ ! -r "$DISKSIZE" ]; then
  echo "0 \"zram used\" zram_filled=0MB;0MB;0MB;0MB;0MB zram not active"
  echo "0 \"zram compression\" compression_ratio=0 zram not active"
  exit 0
fi

read orig compr mem limit max same compact huge huge_since < "$STAT"
zram_size=$(cat "$DISKSIZE")

# ------------------------------------------------------------
# helpers
# ------------------------------------------------------------
human() {
  awk -v x="$1" 'BEGIN {
    unit[1]="B"; unit[2]="KB"; unit[3]="MB"; unit[4]="GB"; unit[5]="TB"
    i=1
    while (x>=1024 && i<5) { x/=1024; i++ }
    printf "%.2f%s", x, unit[i]
  }'
}

orig_h=$(human "$orig")
mem_h=$(human "$mem")

# ------------------------------------------------------------
# compression ratio
# ------------------------------------------------------------
if [ "$compr" -gt 0 ]; then
  ratio=$(awk "BEGIN { printf \"%.2f\", $orig / $compr }")
else
  ratio="0"
fi

# ------------------------------------------------------------
# relative fullness + state
# ------------------------------------------------------------
state=0
fill_pct=0

if [ "$zram_size" -gt 0 ]; then
  fill_pct=$(awk "BEGIN { printf \"%.0f\", ($orig*100)/$zram_size }")
  [ "$fill_pct" -ge "$WARN_PCT" ] && state=1
  [ "$fill_pct" -ge "$CRIT_PCT" ] && state=2
fi

# ------------------------------------------------------------
# thresholds in bytes (derived from percent)
# ------------------------------------------------------------
warn_bytes=$(awk "BEGIN { printf \"%.0f\", ($zram_size*$WARN_PCT)/100 }")
crit_bytes=$(awk "BEGIN { printf \"%.0f\", ($zram_size*$CRIT_PCT)/100 }")

# ------------------------------------------------------------
# convert to MB for perfdata (display only)
# ------------------------------------------------------------
orig_mb=$((orig / 1024 / 1024))
warn_mb=$((warn_bytes / 1024 / 1024))
crit_mb=$((crit_bytes / 1024 / 1024))
zram_size_mb=$((zram_size / 1024 / 1024))

# ------------------------------------------------------------
# Service 1: zram used (stateful, logical volume in MB)
# ------------------------------------------------------------
echo "$state \"zram used\" \
zram_filled=${orig_mb}MB;${warn_mb}MB;${crit_mb}MB;0MB;${zram_size_mb}MB \
logical=$orig_h real=$mem_h fill=${fill_pct}% compression=${ratio}:1"

# ------------------------------------------------------------
# Service 2: zram compression (informational)
# ------------------------------------------------------------
echo "0 \"zram compression\" \
compression_ratio=${ratio} \
compression ratio ${ratio}:1"
