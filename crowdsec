#!/usr/bin/env python3
import subprocess
import re
import sys
from pathlib import Path

# ------------------------------------------------------------
# Config
# ------------------------------------------------------------
CFG_PATH = Path("/etc/check_mk_agent.d/crowdsec.conf")

DEFAULT_DECISIONS_WARN = 100
DEFAULT_DECISIONS_CRIT = 300


def load_config() -> dict[str, str]:
    cfg: dict[str, str] = {}
    if CFG_PATH.exists():
        for raw in CFG_PATH.read_text().splitlines():
            line = raw.strip()
            if not line or line.startswith("#") or "=" not in line:
                continue
            k, v = line.split("=", 1)
            cfg[k.strip()] = v.strip()
    return cfg


cfg = load_config()

DECISIONS_WARN = int(cfg.get("DECISIONS_WARN", DEFAULT_DECISIONS_WARN))
DECISIONS_CRIT = int(cfg.get("DECISIONS_CRIT", DEFAULT_DECISIONS_CRIT))

# ------------------------------------------------------------
def run(cmd):
    try:
        return subprocess.check_output(cmd, stderr=subprocess.STDOUT, text=True)
    except subprocess.CalledProcessError as e:
        return e.output
    except Exception:
        return ""


def count_csv_rows(raw: str) -> int:
    """
    Count only rows that start with a numeric ID.
    This matches real decisions exactly for
    `cscli --output raw decisions list`.
    """
    count = 0
    for line in raw.splitlines():
        line = line.strip()
        if re.match(r"^\d+,", line):
            count += 1
    return count


# ------------------------------------------------------------
# 1. LAPI reachable (NO perfdata → numeric state)
# ------------------------------------------------------------
lapi = run(["cscli", "lapi", "status"])

if "You can successfully interact with Local API" in lapi:
    print('0 "crowdsec lapi" - LAPI reachable')
elif lapi:
    msg = lapi.strip().splitlines()[-1]
    print(f'2 "crowdsec lapi" - {msg}')
else:
    print('3 "crowdsec lapi" - cscli lapi status failed')
    print('3 "crowdsec decisions" - no lapi available')
    sys.exit(0)

# ------------------------------------------------------------
# 2. Decisions (WITH perfdata → P)
# ------------------------------------------------------------
dec_raw = run(["cscli", "--output", "raw", "decisions", "list"])
decisions = count_csv_rows(dec_raw)

print(
    f'P "crowdsec decisions" '
    f'decisions={decisions};{DECISIONS_WARN};{DECISIONS_CRIT} '
    f'{decisions} active decisions'
)
